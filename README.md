# AWS GuardDuty & Security Hub CSPM Integration

[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](LICENSE)
[![AWS](https://img.shields.io/badge/AWS-232F3E?style=flat&logo=amazon-aws&logoColor=white)](https://aws.amazon.com/)
[![CloudFormation](https://img.shields.io/badge/CloudFormation-FF9900?style=flat&logo=amazon-aws&logoColor=white)](https://aws.amazon.com/cloudformation/)

Automatically resolve SecurityHub CSPM findings generated by GuardDuty.

## Table of Contents
- [AWS GuardDuty \& Security Hub CSPM Integration](#aws-guardduty--security-hub-cspm-integration)
  - [Table of Contents](#table-of-contents)
  - [üìå Introduction](#-introduction)
  - [üõ† What it does](#-what-it-does)
  - [üìê Design \& Architecture](#-design--architecture)
    - [Assumptions](#assumptions)
    - [Workflow](#workflow)
  - [üöÄ Deployment \& Customization](#-deployment--customization)
    - [1. Close-on-Archive Logic (`guardduty-securityhub-autoclose.yaml`)](#1-close-on-archive-logic-guardduty-securityhub-autocloseyaml)
    - [2. Auto-Archive Logic (`guardduty-autoarchive.yaml`)](#2-auto-archive-logic-guardduty-autoarchiveyaml)
  - [üìã Common Configuration \& Logging](#-common-configuration--logging)
  - [‚öñÔ∏è License](#Ô∏è-license)

## üìå Introduction
Amazon GuardDuty is natively integrated with **AWS Security Hub** (serving as your Cloud Security Posture Management - CSPM tool) so that findings created in GuardDuty automatically appear in Security Hub. 

**The Problem:** This integration is one-way regarding status updates. If a finding is archived in GuardDuty, it remains **ACTIVE** in Security Hub. This leads to "alert fatigue" and a lack of synchronization between your detection and posture management dashboards.

**The Solution:** This repository provides automation to ensure that finding states are synchronized. When a GuardDuty finding is archived‚Äîeither manually or automatically‚Äîit is immediately resolved in Security Hub.

## üõ† What it does
This repository contains two CloudFormation templates to manage the finding lifecycle:

1.  **`guardduty-securityhub-autoclose.yaml` (Core)**
    * Listens for GuardDuty `ArchiveFindings` events.
    * Triggers a Lambda function to set the corresponding Security Hub finding to `RESOLVED`.
2.  **`guardduty-autoarchive.yaml` (Optional)**
    * Automatically archives GuardDuty findings based on a customizable **age** and **severity** threshold.
    * These archive events are then processed by the first template, closing the loop in Security Hub.

## üìê Design & Architecture
### Assumptions
* An **Audit Account** is configured as the Delegated Administrator for both Security Hub and GuardDuty.
* Security Hub is configured with **Cross-Region Aggregation** enabled in a specific "Home" region.

### Workflow
![GuardDuty-SecurityHub CSPM Integration Design](images/guardduty-securityhub-cspm-integration.drawio.png)
*Figure 1: GuardDuty-SecurityHubCSPM Integration Design*

[Design Source - draw.io](https://github.com/alexbar-hub/aws-guardduty-securityhub-cspm-integration/blob/main/images/guardduty-securityhub-cspm-integration.drawio)

## üöÄ Deployment & Customization
Deploy these templates via **CloudFormation StackSets** in the following order:

### 1. Close-on-Archive Logic (`guardduty-securityhub-autoclose.yaml`)
**Deployment Area:** Deploy this **only** in the Security Hub Aggregator (Home) region.

| Parameter | Description |
| :--- | :--- |
| **Lambda Function Name** | Custom name for the synchronization function. |
| **EventBridge Rule Name** | Name for the rule intercepting GuardDuty events. |
| **IAM Role Name** | Custom name for the execution role. |
| **Deployment Region** | Appended to the IAM role to ensure global uniqueness. |

When a GuardDuty finding gets archived, the `ArchiveFindings` event is intercepted by the EventBridge rule that then triggers a Lambda function that parses the event, gets its Id, and then updates the corresponding finding in SecurityHub CSPM.

### 2. Auto-Archive Logic (`guardduty-autoarchive.yaml`)
**Deployment Area:** Deploy in **all regions** where GuardDuty is active.

| Parameter | Description |
| :--- | :--- |
| **Lambda Function Name** | Custom name for the auto-archive function. |
| **EventBridge Rule Name** | Name for the rule intercepting GuardDuty events. |
| **IAM Role Name** | Custom name for the execution role. |
| **Deployment Region** | Appended to the IAM role to ensure global uniqueness. |
| **Finding Age** | Age of findings (in months) to archive. |
| **Severity Threshold** | Findings below this severity level will be archived. |

The EventBridge rule is set to run on a schedule and triggers the Lambda function. The Lambda function gets the GuardDuty findings and archives the ones with a certain age and below a certain severity. The age and severity thresholds are both confgurable as parameters.

## üìã Common Configuration & Logging
* **Logging:** All logs from the Lambda functions are stored in a custom **CloudWatch Log Group**.
* **Retention:** Logs are kept for **90 days** by default to assist with auditing while managing storage costs.
* **Permissions:** The templates deploy least-privilege IAM roles required to update finding metadata.

## ‚öñÔ∏è License

This project is licensed under the Apache License 2.0 - see the [LICENSE](LICENSE) file for details.